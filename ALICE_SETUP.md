# Полная инструкция по настройке навыка в Алисе

## Шаг 1: Регистрация и создание навыка

1. **Зайди на платформу разработчиков Алисы:**
   - Открой [https://dialogs.yandex.ru/](https://dialogs.yandex.ru/)
   - Войди через Яндекс ID

2. **Создай новый навык:**
   - Нажми кнопку **"Создать навык"**
   - Выбери тип: **"Смартап"** (умное приложение)
   - Название навыка: например, **"Ответчик на отзывы"** или **"Автоответчик Wildberries"**
   - Описание: "Автоматическая генерация и отправка ответов на отзывы Wildberries"

## Шаг 2: Настройка сценария (интентов)

### 2.1. Создание интента "ответь на отзывы"

1. В разделе **"Сценарий"** или **"Интенты"** создай новый интент:
   - **Название интента:** `reply_to_feedbacks` или `ответить_на_отзывы`

2. **Добавь примеры фраз (training phrases):**
   ```
   ответь на отзывы
   ответить на отзывы
   обработай отзывы
   отправь ответы на отзывы
   сгенерируй ответы на отзывы
   обработай все отзывы
   ответь на все отзывы
   запусти обработку отзывов
   ```

3. **Сохрани интент**

### 2.2. Настройка обработчика интента

В разделе **"Обработчики"** или **"Webhook"**:

1. **Включи Webhook:**
   - URL: `http://63.250.56.175/api/auto-reply-5-stars-feedbacks`
   - Метод: **POST**
   - Формат: **JSON**

2. **Настрой обработчик для интента `reply_to_feedbacks`:**
   - При получении интента `reply_to_feedbacks` → отправь POST запрос на webhook

## Шаг 3: Настройка Webhook в коде (опционально, для правильного ответа Алисе)

Если нужно, чтобы Алиса отвечала пользователю, можно добавить обработку запросов от Алисы.

### Формат запроса от Алисы:

```json
{
  "request": {
    "command": "ответь на отзывы",
    "original_utterance": "ответь на отзывы",
    "type": "SimpleUtterance"
  },
  "session": {
    "session_id": "...",
    "user_id": "..."
  },
  "version": "1.0"
}
```

### Формат ответа для Алисы:

```json
{
  "response": {
    "text": "Обработка отзывов запущена. Сгенерировано ответов: 10, отправлено на 5-звёздочные отзывы: 3.",
    "end_session": false
  },
  "version": "1.0"
}
```

## Шаг 4: Модификация эндпоинта для работы с Алисой (если нужно)

Если хочешь, чтобы Алиса озвучивала результат, можно модифицировать эндпоинт:

```python
@app.post("/api/auto-reply-5-stars-feedbacks")
async def auto_reply_5_stars_feedbacks(request: dict = None):
    """
    Эндпоинт для автоматической обработки отзывов.
    Может работать как простой POST (для навыка Алисы) или с телом запроса.
    """
    # ... существующий код обработки ...
    
    result = {
        "status": "ok",
        "message": "Автообработка отзывов завершена.",
        "total_feedbacks": len(feedbacks),
        "generated": generated_count,
        "cached": cached_count,
        "replied_5_stars": replied_count,
        "errors": errors,
    }
    
    # Если это запрос от Алисы, верни формат для Алисы
    if request and "request" in request:
        alice_response = {
            "response": {
                "text": (
                    f"Обработка завершена. "
                    f"Всего отзывов: {result['total_feedbacks']}, "
                    f"сгенерировано новых: {result['generated']}, "
                    f"уже было в кэше: {result['cached']}, "
                    f"отправлено ответов на 5-звёздочные отзывы: {result['replied_5_stars']}."
                ),
                "end_session": False
            },
            "version": "1.0"
        }
        return alice_response
    
    # Иначе верни обычный JSON
    return result
```

## Шаг 5: Тестирование навыка

1. **В панели разработчика:**
   - Перейди в раздел **"Тестирование"**
   - Введи фразу: **"ответь на отзывы"**
   - Проверь, что запрос уходит на твой webhook

2. **Проверь логи на сервере:**
   ```bash
   docker compose logs -f backend
   ```

3. **Проверь работу эндпоинта вручную:**
   ```bash
   curl -X POST http://63.250.56.175/api/auto-reply-5-stars-feedbacks
   ```

## Шаг 6: Публикация навыка

1. **Заполни информацию о навыке:**
   - Название для пользователей
   - Описание
   - Иконка (опционально)

2. **Отправь на модерацию:**
   - Нажми **"Отправить на модерацию"**
   - Дождись одобрения (обычно 1-3 дня)

3. **После публикации:**
   - Пользователи смогут активировать навык фразой: **"Алиса, запусти [название навыка]"**
   - Или использовать твой интент: **"Алиса, ответь на отзывы"**

## Шаг 7: Использование навыка

После публикации пользователи смогут:

1. **Активировать навык:**
   - "Алиса, запусти [название навыка]"
   - "Алиса, включи [название навыка]"

2. **Использовать команду:**
   - "Алиса, ответь на отзывы"
   - "Алиса, обработай отзывы"
   - "Алиса, отправь ответы на отзывы"

## Важные моменты:

1. **HTTPS:** Алиса требует HTTPS для webhook в продакшене. Для тестирования HTTP может работать, но для публикации нужен SSL сертификат.

2. **Таймауты:** Алиса ждёт ответ не более 3 секунд. Если обработка долгая, лучше вернуть ответ сразу, а обработку делать асинхронно.

3. **Обработка ошибок:** Всегда возвращай валидный JSON, даже при ошибках.

## Быстрая настройка через простой webhook (без модификации кода)

Если не хочешь менять код, можно просто настроить webhook в Алисе на твой эндпоинт:

1. В настройках навыка → **Webhook**
2. URL: `http://63.250.56.175/api/auto-reply-5-stars-feedbacks`
3. Метод: **POST**
4. В обработчике интента `reply_to_feedbacks` → отправь POST на этот URL

Алиса просто вызовет твой эндпоинт, и обработка запустится. Ответ от эндпоинта Алиса проигнорирует, но обработка выполнится.

