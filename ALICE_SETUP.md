# Полная инструкция по настройке навыка в Алисе

## Шаг 1: Регистрация и создание навыка

1. **Зайди на платформу разработчиков Алисы:**
   - Открой [https://dialogs.yandex.ru/](https://dialogs.yandex.ru/)
   - Войди через Яндекс ID

2. **Создай новый навык:**
   - Нажми кнопку **"Создать навык"**
   - Выбери тип: **"Смартап"** (умное приложение)
   - Название навыка: например, **"Ответчик на отзывы"** или **"Автоответчик Wildberries"**
   - Описание: "Автоматическая генерация и отправка ответов на отзывы Wildberries"

## Шаг 2: Настройка сценария (интентов)

### 2.1. Создание единого интента для всех команд

В Яндекс Диалогах используй **один интент** `wildresponder.manage` для всех команд. Это упростит обработку.

1. В разделе **"Сценарий"** → **"Интенты"** создай новый интент:
   - **Название интента:** `wildresponder.manage`

2. **Добавь примеры фраз (training phrases):**
   ```
   ответь на отзывы
   ответить на отзывы
   обработай отзывы
   отправь ответы на отзывы
   сгенерируй ответы на отзывы
   обработай все отзывы
   ответь на все отзывы
   запусти обработку отзывов
   сколько отзывов
   сколько неотвеченных отзывов
   сколько всего отзывов
   покажи количество отзывов
   сколько вопросов
   сколько неотвеченных вопросов
   покажи количество вопросов
   сколько пять звёзд
   сколько пятизвёздочных
   сколько отзывов с пятью звёздами
   процент пять звёзд
   статистика по пятизвёздочным
   какие отзывы остались
   каких отзывов осталось
   какие отзывы есть
   покажи какие отзывы остались
   прочитай отзывы
   прочитай все отзывы
   прочитай неотвеченные отзывы
   озвучь отзывы
   расскажи про отзывы
   ответь на отзыв 1
   ответь на отзыв один
   ответь на первый отзыв
   ответь на отзывы 1 и 2
   ответь на отзывы один и два
   ответь на отзывы 1, 2 и 3
   ответь на отзывы 1, 3
   ответь на все отзывы
   ответь на все оставшиеся отзывы
   статус задачи
   статус задачи 1
   статус задачи один
   результат задачи
   результат задачи 1
   как дела с задачей
   что с задачей
   ```

3. **Сохрани интент**

### 2.2. Настройка обработчика интента

В разделе **"Обработчики"** или **"Webhook"**:

1. **Включи Webhook:**
   - URL: `https://wildresponder.run.place/api/alice-webhook`
   - Метод: **POST**
   - Формат: **JSON**

2. **Настрой обработчик для интента `wildresponder.manage`:**
   - При получении интента `wildresponder.manage` → отправь POST запрос на webhook
   - Все команды обрабатываются через единый эндпоинт `/api/alice-webhook`

## Шаг 3: Доступные команды навыка

После настройки навыка пользователи смогут использовать следующие команды:

### Основные команды:
- **"Ответь на отзывы"** — запускает автоматическую обработку всех неотвеченных отзывов и отправку ответов на пятизвёздочные
- **"Сколько отзывов"** — показывает количество неотвеченных отзывов и плохих отзывов
- **"Сколько вопросов"** — показывает количество неотвеченных вопросов
- **"Сколько пять звёзд"** — показывает статистику по пятизвёздочным отзывам
- **"Какие отзывы остались"** — показывает список оставшихся отзывов с рейтингами
- **"Прочитай отзывы"** — читает все неотвеченные отзывы с деталями (товар, оценка, плюсы, минусы, комментарий)
- **"Ответь на отзыв 1"** — отвечает на конкретный отзыв по номеру
- **"Ответь на отзывы 1 и 2"** — отвечает на несколько конкретных отзывов
- **"Ответь на все отзывы"** — отвечает на все оставшиеся отзывы
- **"Статус задачи 1"** — показывает результат обработки задачи по номеру

## Шаг 4: Настройка Webhook в коде (опционально, для правильного ответа Алисе)

Если нужно, чтобы Алиса отвечала пользователю, можно добавить обработку запросов от Алисы.

### Формат запроса от Алисы:

```json
{
  "request": {
    "command": "ответь на отзывы",
    "original_utterance": "ответь на отзывы",
    "type": "SimpleUtterance"
  },
  "session": {
    "session_id": "...",
    "user_id": "..."
  },
  "version": "1.0"
}
```

### Формат ответа для Алисы:

```json
{
  "response": {
    "text": "Обработка отзывов запущена. Сгенерировано ответов: 10, отправлено на 5-звёздочные отзывы: 3.",
    "end_session": false
  },
  "version": "1.0"
}
```

## Шаг 5: Модификация эндпоинта для работы с Алисой (если нужно)

Если хочешь, чтобы Алиса озвучивала результат, можно модифицировать эндпоинт:

```python
@app.post("/api/auto-reply-5-stars-feedbacks")
async def auto_reply_5_stars_feedbacks(request: dict = None):
    """
    Эндпоинт для автоматической обработки отзывов.
    Может работать как простой POST (для навыка Алисы) или с телом запроса.
    """
    # ... существующий код обработки ...
    
    result = {
        "status": "ok",
        "message": "Автообработка отзывов завершена.",
        "total_feedbacks": len(feedbacks),
        "generated": generated_count,
        "cached": cached_count,
        "replied_5_stars": replied_count,
        "errors": errors,
    }
    
    # Если это запрос от Алисы, верни формат для Алисы
    if request and "request" in request:
        alice_response = {
            "response": {
                "text": (
                    f"Обработка завершена. "
                    f"Всего отзывов: {result['total_feedbacks']}, "
                    f"сгенерировано новых: {result['generated']}, "
                    f"уже было в кэше: {result['cached']}, "
                    f"отправлено ответов на 5-звёздочные отзывы: {result['replied_5_stars']}."
                ),
                "end_session": False
            },
            "version": "1.0"
        }
        return alice_response
    
    # Иначе верни обычный JSON
    return result
```

## Шаг 6: Тестирование навыка

1. **В панели разработчика:**
   - Перейди в раздел **"Тестирование"**
   - Введи фразу: **"ответь на отзывы"**
   - Проверь, что запрос уходит на твой webhook

2. **Проверь логи на сервере:**
   ```bash
   docker compose logs -f backend
   ```

3. **Проверь работу эндпоинта вручную:**
   ```bash
   curl -X POST http://63.250.56.175/api/auto-reply-5-stars-feedbacks
   ```

## Шаг 7: Публикация навыка

1. **Заполни информацию о навыке:**
   - Название для пользователей
   - Описание
   - Иконка (опционально)

2. **Отправь на модерацию:**
   - Нажми **"Отправить на модерацию"**
   - Дождись одобрения (обычно 1-3 дня)

3. **После публикации:**
   - Пользователи смогут активировать навык фразой: **"Алиса, запусти [название навыка]"**
   - Или использовать твой интент: **"Алиса, ответь на отзывы"**

## Шаг 8: Использование навыка

После публикации пользователи смогут:

1. **Активировать навык:**
   - "Алиса, запусти [название навыка]"
   - "Алиса, включи [название навыка]"

2. **Использовать команду:**
   - "Алиса, ответь на отзывы"
   - "Алиса, обработай отзывы"
   - "Алиса, отправь ответы на отзывы"

## Важные моменты:

1. **HTTPS:** Алиса требует HTTPS для webhook в продакшене. Для тестирования HTTP может работать, но для публикации нужен SSL сертификат.

2. **Таймауты:** Алиса ждёт ответ не более 3 секунд. Если обработка долгая, лучше вернуть ответ сразу, а обработку делать асинхронно.

3. **Обработка ошибок:** Всегда возвращай валидный JSON, даже при ошибках.

## Быстрая настройка через простой webhook (без модификации кода)

Если не хочешь менять код, можно просто настроить webhook в Алисе на твой эндпоинт:

1. В настройках навыка → **Webhook**
2. URL: `https://wildresponder.run.place/api/alice-webhook`
3. Метод: **POST**
4. В обработчике интента `wildresponder.manage` → отправь POST на этот URL

Все команды обрабатываются через единый webhook `/api/alice-webhook`, который распознаёт команды по тексту и возвращает ответы в формате для Алисы.

